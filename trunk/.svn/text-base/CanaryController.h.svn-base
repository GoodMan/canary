//
//  CanaryController.h
//  Canary
//
//  Created by Nicholas Toumpelis on 20/02/2008.
//  Copyright 2008 Ocean Road Software. All rights reserved.
//
//  0.2 - 16/04/2008
//  0.3 - 13/09/2008
//  0.4 - 23/09/2008
//  0.5 - 03/10/2008

#import <Cocoa/Cocoa.h>
#import <CoreFoundation/CoreFoundation.h>
#import <CoreServices/CoreServices.h>
#import "ORSShortener.h"
#import "ORSAuthenicator.h"
#import "ORSTwitterEngine.h"
#import "ORSShortenerFactory.h"
#import "ORSUpdateDispatcher.h"
#import "ORSDateDifferenceFormatter.h"
#import "NSXMLNode+ORSTwitterStatusAdditions.h"
#import "NSXMLNode+ORSTwitterDMAdditions.h"
#import "ORSTwitterEngine+FavoritesAndDMAdditions.h"
#import "ORSCanaryPreferencesController.h"
#import "ORSCanaryAboutController.h"
#import "ORSTwitterEngine+StatusAdditions.h"

@interface CanaryController : NSWindowController {
	// Fundamentals
	ORSAuthenicator *authenticator;
	ORSTwitterEngine *twitterEngine;
	id <ORSShortener> urlShortener;
	ORSUpdateDispatcher *updateDispatcher;
	// Extra Windows
	IBOutlet NSWindow *aboutWindow;
	// User Manager Outlets
	IBOutlet NSWindow *userManagerWindow;
	IBOutlet NSComboBox *userIDComboBox;
	IBOutlet NSSecureTextField *passwordSecureTextField;
	IBOutlet NSTextField *authenticatedTextField;
	// Status View Outlets
	IBOutlet NSTextField *statusTextField;
	IBOutlet NSView *statusView;
	IBOutlet NSBox *statusBox;
	IBOutlet NSTextField *dateDifferenceTextField;
	// Main Window Outlets
	IBOutlet NSCollectionView *mainTimelineCollectionView;
	IBOutlet NSScrollView *mainTimelineScrollView;
	IBOutlet NSTextField *newStatusTextField;
	IBOutlet NSButton *tweetButton;
	IBOutlet NSLevelIndicator *charsLeftIndicator;
	IBOutlet NSPopUpButton *timelineButton;
	IBOutlet NSProgressIndicator *indicator;
	IBOutlet NSView *contentView;
	IBOutlet NSCollectionViewItem *mainTimelineCollectionViewItem;
	// Received DMs Collection View Outletss
	IBOutlet NSCollectionView *receivedDMsCollectionView;
	IBOutlet NSScrollView *receivedDMsScrollView;
	// Sent DMs Collection View Outlets
	IBOutlet NSCollectionView *sentDMsCollectionView;
	IBOutlet NSScrollView *sentDMsScrollView;
	// Received DMs View Outlets
	IBOutlet NSTextField *receivedDMTextField;
	IBOutlet NSView *receivedDMView;
	IBOutlet NSBox *receivedDMBox;
	IBOutlet NSTextField *receivedDMDateDifferenceTextField;
	// Sent DMs View Outlets
	IBOutlet NSTextField *sentDMTextField;
	IBOutlet NSView *sentDMView;
	IBOutlet NSBox *sentDMBox;
	IBOutlet NSTextField *sentDMDateDifferenceTextField;
	// Array Controllers
	IBOutlet NSArrayController *statusArrayController;
	
	NSArray *statuses;
	NSArray *receivedDirectMessages;
	NSArray *sentDirectMessages;
	NSUserDefaults *defaults;
	
	NSTimer *refreshTimer;
	SecKeychainItemRef loginItem;
	NSString *visibleUserID;
	
	NSString *prevUserID;
	NSString *prevPassword;
	
	NSArray *spokenCommands;
	NSSpeechRecognizer *recognizer;
	NSString *previousTimeline;
	
	// Intermediate caches
	NSMutableArray *followingStatusCache, *repliesStatusCache, 
		*publicStatusCache, *archiveStatusCache, *receivedMessagesCache,
		*sentMessagesCache, *favoritesStatusCache;
	BOOL firstFollowingCall, firstRepliesCall, firstPublicCall, 
		firstArchiveCall, firstReceivedMessagesCall, firstSentMessagesCall,
		firstFavoriteCall;
	NSString *lastFollowingStatusID, *lastReplyStatusID, *lastPublicStatusID,
		*lastArchiveStatusID, *lastReceivedMessageID, *lastSentMessageID, 
		*lastFavoriteStatusID;
}

+ (CanaryController *) sharedController;
+ (id) allocWithZone:(NSZone *)zone;
- (void) applicationDidFinishLaunching:(NSNotification *)aNotification;
- (IBAction) sendUpdate:sender;
- (IBAction) changeTimeline:sender;
- (void) updateTimer;
- (void) updateMaxNoOfShownUpdates;
- (void) updateSelectedURLShortener;
- (void) setStatusesAsynchronously:(NSNotification *)note;
- (void) setUsersAsynchronously:(NSNotification *)note;
- (void) setDMsAsynchronously:(NSNotification *)note;
- (void) addSentStatusAsynchronously:(NSNotification *)note;
- (void) addSentDMsAsynchronously:(NSNotification *)note;
- (void) getFriendsTimeline;
- (void) getUserTimeline;
- (void) getPublicTimeline;
- (void) getReplies;
- (void) getFavorites;
- (void) getReceivedMessages;
- (void) getSentMessages;
- (IBAction) goHome:sender;
- (IBAction) showUserManagerSheet:sender;
- (IBAction) closeUserManagerSheet:sender;
- (IBAction) login:sender;
- (void) didEndUserManagerSheet:(NSWindow *)sheet
					 returnCode:(int)returnCode
					contextInfo:(void *)contextInfo;
- (IBAction) typeUserID:sender;
- (IBAction) dmUserID:sender;
- (IBAction) shortenURL:sender;
- (IBAction) openUserURL:sender;
- (void) fillPasswordTextField;
- (IBAction) invokeActionOnUser:sender;
- (IBAction) showAboutWindow:sender;
- (IBAction) showPreferencesWindow:sender;
- (IBAction) sendFeedback:sender;

- (IBAction) listen:sender;
- (void) speechRecognizer:(NSSpeechRecognizer *)sender
	  didRecognizeCommand:(id)aCommand;

// Friendship methods
- (void) createFriendshipWithUser:(NSString *)userID;
- (void) destroyFriendshipWithUser:(NSString *)userID;

// Block methods
- (void) blockUserWithID:(NSString *)userID;
- (void) unblockUserWithID:(NSString *)userID;

// Notification methods
- (void) followUserWithID:(NSString *)userID;
- (void) leaveUserWithID:(NSString *)userID;

// Favorite methods
- (void) favoriteStatusWithID:(NSString *)statusID;

// Methods using the main preferences
- (float) timelineRefreshPeriod ;
- (int) maxShownUpdates;
- (int) selectedURLShortener;

@property(copy) NSArray *statuses;
@property(copy) NSArray *receivedDirectMessages;
@property(copy) NSArray *sentDirectMessages;
@property(copy) NSString *visibleUserID;
@property(copy) NSString *previousTimeline;
@property(copy) NSMutableArray *followingStatusCache, *repliesStatusCache,
				*publicStatusCache, *archiveStatusCache, *receivedMessagesCache,
				*sentMessagesCache, *favoritesStatusCache;
@property() BOOL firstFollowingCall, firstRepliesCall, firstPublicCall,
				 firstArchiveCall, firstReceivedMessagesCall, 
				 firstSentMessagesCall, firstFavoriteCall;
@property(copy) NSString *lastFollowingStatusID, *lastReplyStatusID,
				*lastPublicStatusID, *lastArchiveStatusID, 
				*lastReceivedMessageID, *lastSentMessageID, 
				*lastFavoriteStatusID;

@end
